#!/bin/bash
###########################################################################################
# Nom : EXPLOIT_STAMBIA_RUNTIME [EURODIF]                                                 #
# Description : ce script sert a effectuer l'arret/relance/purge des rutime Stambia       #
# Auteur : Exploitation ASTEN [QGU]                                                       #
# Date de Creation : 06/11/2020                                                           #
# Date Last Modif  : xx/xx/xxxx                                                           #
###########################################################################################

##############################[ Récupération des Variables ]##############################
chemin=$1
runtime=$2
action=$3

##############################[ Declaration des Fonctions ]##############################
# Fonction de Temporisation
function Tempo()
{
	MULT=$1
	TEMPO=$((10*MULT))
	sleep $TEMPO
}

# Fonction du check de l'arret du process stambia
function CheckStopPS()
{
	echo " - Verification non-presence process : $1/startengine.sh"
	PS=$(ps -aef | grep "$1/startengine.sh" | grep -v grep | awk '{print $2}')
	CR=0
	CT=0
	until [ ${CR} == 1 ]
	do
		Tempo 2
		ps -aef | grep "$1/startengine.sh" | grep -v grep
		if [ $? == 0 ]
		then
			CT=$((CT + 1))
			echo " -- [${CT}] process ${PS} toujours present"
		else
			echo " -- [${CT}] process ${PS} non-present"
			CR=1
		fi
		if [ ${CT} == 5 ]
		then
			echo " --> kill du process : ${PS}"
			/usr/bin/kill -9 ${PS}
		fi
	done
}

# Fonction du check du lancement du process stambia
function CheckStartPS()
{
	echo " - Verification presence process : $1/startengine.sh"
	PS=$(ps -aef | grep "$1/startengine.sh" | grep -v grep | awk '{print $2}')
	CR=0
	CT=0
	until [ ${CR} == 1 ]
	do
		Tempo 2
		ps -aef | grep "$1/startengine.sh" | grep -v grep
		if [ $? == 0 ]
		then
			echo " -- [${CT}] process ${PS} est present"
			grep "INFO  - 0   : EngineServerI() : Engine Started !" $1/log/com.indy.engine.$2.log
			if [ $? == 0 ]
			then
				echo " -- [Engine : OK]"
				CR=1
			fi
		else
			CT=$((CT + 1))
			echo " -- [${CT}] process ${PS} n'est toujours present"
		fi
		if [ ${CT} == 5 ]
		then
			echo " --> process ${PS} non-present après ${CT} essais"
			exit 1
		fi
	done
}

##############################[ Debut du Programme ]##############################
case $runtime in
	"Sstambia-1")
		export STAMBIA_HOME=$STAMBIA_HOME1
		export STAMBIA_PORT=42000 ;;
	"Sstambia-2")
		export STAMBIA_HOME=$STAMBIA_HOME2
		export STAMBIA_PORT=43000 ;;
	"Sstambia-3")
		export STAMBIA_HOME=$STAMBIA_HOME3
		export STAMBIA_PORT=44000 ;;
	"Sstambia-4")
		export STAMBIA_HOME=$STAMBIA_HOME4
		export STAMBIA_PORT=45000 ;;
	"Sstambia-5")
		export STAMBIA_HOME=$STAMBIA_HOME5
		export STAMBIA_PORT=46000 ;;
	*)
		echo $"Usage: $parm runtime {Sstambia-1 | Sstambia-2 | Sstambia-3 | Sstambia-4 | Sstambia-5}"
		exit 1 ;;
esac

export STAMBIA_PROPERTIES_LOCATION=$STAMBIA_HOME/properties
export STAMBIA_PURGE=30

case $action in
	"purge")
		date
		echo " - $action : $runtime"
		cd $STAMBIA_HOME
		echo " => $STAMBIA_HOME/startcommand.sh \"connect to ${MACHINE_PROD} port ${STAMBIA_PORT};purge keep ${STAMBIA_PURGE} day\""
		$STAMBIA_HOME/startcommand.sh "connect to ${MACHINE_PROD} port ${STAMBIA_PORT};purge keep ${STAMBIA_PURGE} day"
		Tempo 6 ;;
	"start")
		date
		echo " - $action : $runtime"
		cd $chemin
		echo " => $chemin/${runtime} start"
		$chemin/${runtime} start
		CheckStartPS $STAMBIA_HOME $STAMBIA_PORT
		Tempo 6 ;;
	"stop")
		date
		echo " - $action : $runtime"
		cd $chemin
		echo " => $chemin/${runtime} stop"
		$chemin/${runtime} stop
		CheckStopPS $STAMBIA_HOME
		LOGBCKDTE=$(date +%Y%m%d_%H%M)
		mv $STAMBIA_HOME/log/com.indy.engine.$STAMBIA_PORT.actions.log $STAMBIA_HOME/log/$LOGBCKDTE-com.indy.engine.$STAMBIA_PORT.actions.log
		mv $STAMBIA_HOME/log/com.indy.engine.$STAMBIA_PORT.actionCodes.log $STAMBIA_HOME/log/$LOGBCKDTE-com.indy.engine.$STAMBIA_PORT.actionCodes.log
		mv $STAMBIA_HOME/log/com.indy.engine.$STAMBIA_PORT.jdbc.log $STAMBIA_HOME/log/$LOGBCKDTE-com.indy.engine.jdbc.$STAMBIA_PORT.log
		mv $STAMBIA_HOME/log/com.indy.engine.$STAMBIA_PORT.scheduler.log $STAMBIA_HOME/log/$LOGBCKDTE-com.indy.engine.scheduler.$STAMBIA_PORT.log
		mv $STAMBIA_HOME/log/com.indy.engine.$STAMBIA_PORT.log $STAMBIA_HOME/log/$LOGBCKDTE-com.indy.engine.$STAMBIA_PORT.log
		mv $STAMBIA_HOME/log/com.indy.engine.$STAMBIA_PORT.wsdl.log $STAMBIA_HOME/log/$LOGBCKDTE-com.indy.engine.$STAMBIA_PORT.wsdl.log
		mv $STAMBIA_HOME/log/com.indy.engine.$STAMBIA_PORT.memory.log $STAMBIA_HOME/log/$LOGBCKDTE-com.indy.engine.$STAMBIA_PORT.memory.log
		mv $STAMBIA_HOME/log/com.indy.engine.$STAMBIA_PORT.rdbmsLog.log $STAMBIA_HOME/log/$LOGBCKDTE-com.indy.engine.$STAMBIA_PORT.rdbmsLog.log ;;
	*)
		echo $"Usage: parm action {purge | start | stop}"
		exit 1 ;;
esac

##############################[ Fin du Programme ]##############################